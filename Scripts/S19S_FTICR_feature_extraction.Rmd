---
title: "WHONDRS_S19S_analysis"
author: "Jianqiu Zheng"
date: "3/14/2024"
output: html_document
---

```{r setup, include=FALSE}
#Load the required packages
library(tidyverse)
library(dplyr)
library(reshape)
library(ggplot2)
library(ggpubr)
library(scales)
library(ggpmisc)
theme_pubclean()



```

## creating a lookup table with mass
## Mass,MolForm, ID, Position
```{r metadata}
#Load WHONDRS S19S data (presence/absence)
data <- read.csv('Processed_Clean_S19S_Water_Field_sediments_9-29_Data.csv')

#Load WHONDRS S19S molarity data 
mol <- read.csv('Processed_Clean_S19S_Water_Field_sediments_9-29_Mol.csv')

#Change column header 
names(data)[1] <- "Mass"

#Create ID column
data <- mutate(data, ID = row_number())
mol <- mutate(mol, ID = row_number())

#Subset mol to get df of just Mass and MolForm
mol_subset <- mol %>% select(ID, Mass, MolForm, Class, AI_Mod, DBE, NOSC)

#Merge data and mol
df <- merge(data, mol_subset, by= "ID")

#Select wanted columns and remove NAs and 0 counts
df_subset <- df %>% 
              select(-one_of('ID', 'Mass.y')) %>% 
              select('Mass.x', 'MolForm', everything()) %>% 
              pivot_longer(!c(Mass.x, MolForm, Class, AI_Mod, DBE, NOSC), names_to = "Site_ID", 
                           values_to = "Count") %>%
              filter(Count != 0)%>%
              na.omit()



#Extract the sample type (water or sediment)
df_subset$Type <- ifelse(grepl("Sed", df_subset$Site_ID), "Sediment", "Water")

sed_df <- filter(df_subset, Type == "Sediment")
water_df <- filter(df_subset, Type == "Water")


#clean up metadata file
sed_df$Position<-sub(".*_ICR\\.([A-Za-z]).*", "\\1", sed_df$Site_ID)
sed_df$ID<-sub(".*S19S_([0-9]{4})_Sed.*", "\\1", sed_df$Site_ID)

sed_clean <- sed_df %>% select(-Mass.x, -Site_ID, -Count, -Type)

#Write df to csv file
write.csv(sed_clean,file = "S19S_sed_with_metadata.csv")
# write.csv(water_df,file = "S19S_water_with_metadata.csv")

```


##Match thermodynamic modeling results with samples using the lookup table
```{r cars}
#test read csv file to make sure ID is character
meta<- read.csv("S19S_sed_with_metadata.csv") 

##load modeling results
ther<- read.csv("S19S_sed_oxy.csv")


#Select wanted columns 
ther_subset <- ther %>% 
              select('delGcat','lambda','ne','stoichMet_donor','C_num','CUE')

#Select wanted columns 
meta_subset <- meta %>% 
              select('ID','Position','MolForm',"Class", "AI_Mod","DBE","NOSC")

##match ID, peaks and predictions
ther_meta<- cbind(meta_subset,ther_subset)

unique(ther_meta$ID)


write.csv(ther_meta,file = "S19S_sed_therm_meta_test.csv")

```


#visualize data distribution 

```{r mean}

#density distribution plot
plot1<-ggplot(data=ther_meta, aes(x=CUE))+ 
  #geom_histogram(aes(y=..density..,color=Amendment, fill=Amendment),binwidth=40,alpha=0.2, position="identity")+ 
  geom_density(aes(color=Position), size=1)+
  scale_x_continuous(limits=c(0,1))+
  #scale_y_continuous(limits=c(0, 2e-4),breaks=seq(0,2e-4, by=1e-4))+
  #scale_fill_manual(values = c("#E7B800","#0073C2FF", "#FC4E07","#00AFBB")) +
  #scale_color_manual(values = c("#E7B800","#0073C2FF", "#FC4E07","#00AFBB"))+
  #theme_pubr(border=TRUE)+theme(legend.position=c(0.12,0.75))+  theme(panel.grid.minor.x=element_line(linetype="dashed", color="gray",size=0.2))+
  theme(panel.grid.major.x=element_line(linetype="dashed", color="gray",size=0.2))
## blue, red, yellow:  "#0073C2FF", "#FC4E07","#E7B800"
plot1

```


#Seperating data by ID and position (creating indivisual files, useful or not??)

```{r sep}

ther_data<-read.csv("S19S_sed_therm_meta_test.csv", colClasses = c(ID = "character"))
#Select upstream sediment samples 
up.data = subset(ther_data, Position=="U")

mid.data = subset(ther_data, Position=="M")
low.data = subset(ther_data, Position=="D")
up.data<-up.data[,-1]
mid.data<-mid.data[,-1]
low.data<-low.data[,-1]

#Select for variables of interest---up
var_study <- unique (up.data$ID) %>% sort() #unique study names
length(var_study)
#For each site subset, eliminate rows with 0 and format headers
for (i in 1:length(var_study)) {
   sub_study <- subset(up.data, ID == var_study[i])
  write.csv(sub_study,file=paste0(i,"_up.csv"),row.names = FALSE)
}

#Select for variables of interest--mid
var_study <- unique (mid.data$ID) %>% sort() #unique study names
length(var_study)
#For each site subset, eliminate rows with 0 and format headers
for (i in 1:length(var_study)) {
   sub_study <- subset(mid.data, ID == var_study[i])
  write.csv(sub_study,file=paste0(i,"_mid.csv"),row.names = FALSE)
}


#Select for variables of interest---down
var_study <- unique (low.data$ID) %>% sort() #unique study names
length(var_study)
#For each site subset, eliminate rows with 0 and format headers
for (i in 1:length(var_study)) {
   sub_study <- subset(low.data, ID == var_study[i])
  write.csv(sub_study,file=paste0(i,"_low.csv"),row.names = FALSE)
}

```
#####-----------------------------------------------------------------------------------------




#####-----------------------------------------------------------------------------------------
#Extract all miscellaneous data: rates, npoc, cell counts, grain size
```{r cars}
###using ESS-DIVE dataset v6 ()

#Take sediment wet mass, replace missing values with mean
mass<-read.csv("WHONDRS_S19S_Sediment_Water_Mass_Volume.csv")
mass <- mass %>% select(Sample_ID, Wet_Sediment_Mass_g, Water_Mass_g) #10mL sediment used for incubation
mass[mass==-9999]<-NA
mean<-mean(mass$Wet_Sediment_Mass_g, na.rm=TRUE) ##18.61574
mass[is.na(mass)]<- mean
colnames(mass)<-c("ID","sed_mass","water_mass")

rates<- read.csv("WHONDRS_S19S_Sediment_Incubations_respiration_Rates_v6.csv")
rates<- rates %>% select(Sample_ID,rate_mg_per_L_per_h )
colnames(rates)<-c('ID', 'rate')#mg_DO_per_H_per_L_sediment

raw_npoc<- read.csv("WHONDRS_S19S_Sediment_NPOC.csv") #NPOC_mg_per_L_as_C
colnames(raw_npoc)<-c('study','ID', 'conc')
npoc<-raw_npoc%>% select(ID, conc)
npoc$conc[npoc$conc=="Above_Range_Greater_Than_22"]<-NA


raw_fc<- read.csv("WHONDRS_S19S_Sediment_FlowCytometry.csv")
colnames(raw_fc)<-c('study','ID', 'bac', 'photo', 'hetero')
##testing correlations
test1<-cor(raw_fc$bac,raw_fc$hetero, method='pearson')  ##0.9999
test2<-cor(raw_fc$photo,raw_fc$hetero, method='pearson') ##0.8025
##log10 transfer 
raw_fc$biomass<-log10(raw_fc$hetero)
fc<-raw_fc%>% select(ID, biomass)

raw_gs<- read.csv("WHONDRS_S19S_Sediment_GrainSize.csv")
colnames(raw_gs)<-c('study','ID', 'fine','med','coarse','sand','clay','silt')
##testing correlations
test1<-cor(raw_gs$fine,raw_gs$sand, method='pearson')  ##0.053
test2<-cor(raw_gs$med,raw_gs$sand, method='pearson')  ##0.999
test3<-cor(raw_gs$coarse,raw_gs$sand, method='pearson')  ##-0.09
test4<-cor(raw_gs$clay,raw_gs$sand, method='pearson')  ##0.0005
test5<-cor(raw_gs$silt,raw_gs$sand, method='pearson')  ##0.998

## run a simple/ideal surface area calculation
raw_gs<-subset(raw_gs, select=-c(study,sand))
test_gs<-head(raw_gs, 30)
  
test_gs1<-reshape2::melt(test_gs, id.var="ID")

  
###visualize grainsize distribution 
plot1<-ggplot(test_gs1, aes(x=ID, y=value, fill=variable))+geom_bar(position="stack",stat="identity")+
scale_fill_manual(values=c("#8073ac","#b2abd2","#d8daeb","#fdb863","#b35806"))+
  theme_linedraw()+theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+theme(text = element_text(size=16))+theme(axis.text.x=element_text(angle=90, vjust=0.5,hjust=1))

pdf("example grain size.pdf", width=8, height=5)
plot1
dev.off() 
###calculating surface area
###edge length (mm): fine sand=0.178, med sand=0.375, coarse sand =1.25, clay=0.002, silt=0.0275
### bulk density (g/cm3): 
raw_gs$ssa_tot<-6*(raw_gs$fine*0.178^2+raw_gs$med*0.375^2+raw_gs$coarse*1.25^2+raw_gs$clay*0.002^2+raw_gs$silt*0.0275^2)  # total area

raw_gs$ssa<-6/(raw_gs$fine/0.178/1.6+raw_gs$med/0.375/1.7+raw_gs$coarse/1.25/1.8+raw_gs$clay/0.002/1.4+raw_gs$silt/0.0275/1.55)  ### specific surface per unit mass S=6/(Rho*l)

gs<-raw_gs
```



# Merge all bulk sediment data with FTICR data based on location and site ID
```{r plotting}
#Select samples byID
#----------rate---------------------
up_rates <- rates[grep("SED_INC-U",rates$ID), ] ##grep--globally search for a regular expression and print matching lines---return lines
colnames(up_rates)<-c('ID', 'rate')
unique(up_rates$ID)
up_rates$site = str_extract(up_rates$ID, "[0-9]{4}")
up_rates<-up_rates[,-1]
#----------npoc---------------------
up_npoc<- npoc[grep("Sed_Field_ICR-U",npoc$ID), ] 
up_npoc$site = str_extract(up_npoc$ID, "[0-9]{4}")
up_npoc<-up_npoc[,-1] 

#----------biomass---------------------
up_biomass<- fc[grep("FCS-U",fc$ID), ] 
up_biomass$site = str_extract(up_biomass$ID, "[0-9]{4}")
up_biomass<-up_biomass[,-1] 

#----------sediment mass---------------------
up_mass<- mass[grep("SED_INC-U",mass$ID), ] 
up_mass$site = str_extract(up_mass$ID, "[0-9]{4}")
up_mass<-up_mass[,-1] 

#----------grainsize---------------------
up_gs<- gs[grep("BULK-U",gs$ID), ] 
up_gs$site = str_extract(up_gs$ID, "[0-9]{4}")
up_gs<-up_gs[,-1] 

#merge all miscellaneous data--------------------
up_list<-list(up_rates, up_npoc, up_biomass,up_mass, up_gs)
up<- up_list %>% reduce(full_join, by='site')
up<-na.omit(up)
up$conc <- as.numeric(up$conc)

###fixing units both rate and concentration are in mg g-1
up$resp<-up$rate*(up$water_mass+10)*0.01/up$sed_mass
up$npoc<-up$conc*(up$water_mass+10)*0.01/up$sed_mass
up$respC<-up$resp/32*12 ##convert mgDO g-1 to mgC g-1


up<-select(up, "site","respC","npoc","biomass","clay","silt","fine","med","coarse","ssa_tot")



###merge with thermodynamic modeling results
colnames(up.data)[1]<-"site"

up <- up %>% mutate(site = sprintf("%04d", as.numeric(site)))
up.data <- up.data %>% mutate(site = sprintf("%04d", as.numeric(site)))

#Merge data by site number--modeling results and measured concentration and rates
testtt<-merge (up.data, up,by='site') 
write.csv(testtt,'up_all.csv', row.names = FALSE)

#--------------------
#Select samples
mid_obv <- rates[grep("SED_INC-M",rates$ID), ] ##grep--globally search for a regular expression and print matching lines---return lines
colnames(mid_obv)<-c('ID', 'rate')
unique(mid_obv$ID)
mid_obv$site = str_extract(mid_obv$ID, "[0-9]{4}")
mid_obv<-mid_obv[,-1]

mid_npoc<- npoc[grep("Sed_Field_ICR-M",npoc$ID), ] 
mid_npoc$site = str_extract(mid_npoc$ID, "[0-9]{4}")
mid_npoc<-mid_npoc[,-1] 

#----------biomass---------------------
mid_biomass<- fc[grep("FCS-M",fc$ID), ] 
mid_biomass$site = str_extract(mid_biomass$ID, "[0-9]{4}")
mid_biomass<-mid_biomass[,-1] 

#----------sediment mass---------------------
mid_mass<- mass[grep("SED_INC-M",mass$ID), ] 
mid_mass$site = str_extract(mid_mass$ID, "[0-9]{4}")
mid_mass<-mid_mass[,-1] 

#----------grainsize---------------------
mid_gs<- gs[grep("BULK-M",gs$ID), ] 
mid_gs$site = str_extract(mid_gs$ID, "[0-9]{4}")
mid_gs<-mid_gs[,-1] 

#merge all miscellaneous data--------------------
mid_list<-list(mid_obv, mid_npoc, mid_biomass, mid_mass,mid_gs)
mid<- mid_list %>% reduce(full_join, by='site')

mid<-na.omit(mid)
mid$conc <- as.numeric(mid$conc)

###fixing units both rate and concentration are in mg g-1
mid$resp<-mid$rate*(mid$water_mass+10)*0.01/mid$sed_mass
mid$npoc<-mid$conc*(mid$water_mass+10)*0.01/mid$sed_mass
mid$respC<-mid$resp/32*12 ##convert mgDO g-1 to mgC g-1



mid<-select(mid, "site","respC","npoc","biomass","clay","silt","fine","med","coarse","ssa_tot")

mid[mid==-9999]<-NA

## merge with thermodynamic parameters
colnames(mid.data)[1]<-"site"

mid <- mid %>% mutate(site = sprintf("%04d", as.numeric(site)))
mid.data <- mid.data %>% mutate(site = sprintf("%04d", as.numeric(site)))

#Merge data by site number--modeling results and measured concentration and rates
mid_all<-merge (mid.data, mid,by='site') 
write.csv(mid_all,'mid_all.csv', row.names = FALSE)


#--------------------
#Select samples
low_obv <- rates[grep("SED_INC-D",rates$ID), ] ##grep--globally search for a regular expression and print matching lines---return lines
colnames(low_obv)<-c('ID', 'rate')
unique(low_obv$ID)
low_obv$site = str_extract(low_obv$ID, "[0-9]{4}")
low_obv<-low_obv[,-1]

low_npoc<- npoc[grep("Sed_Field_ICR-D",npoc$ID), ] 
low_npoc$site = str_extract(low_npoc$ID, "[0-9]{4}")
low_npoc<-low_npoc[,-1] 

#----------biomass---------------------
low_biomass<- fc[grep("FCS-D",fc$ID), ] 
low_biomass$site = str_extract(low_biomass$ID, "[0-9]{4}")
low_biomass<-low_biomass[,-1] 

#----------sediment mass---------------------
low_mass<- mass[grep("SED_INC-D",mass$ID), ] 
low_mass$site = str_extract(low_mass$ID, "[0-9]{4}")
low_mass<-low_mass[,-1] 

#----------grainsize---------------------
low_gs<- gs[grep("BULK-D",gs$ID), ] 
low_gs$site = str_extract(low_gs$ID, "[0-9]{4}")
low_gs<-low_gs[,-1] 

#merge all miscellaneous data--------------------
low_list<-list(low_obv, low_npoc, low_biomass,low_mass, low_gs)
low<- low_list %>% reduce(full_join, by='site')

low<-na.omit(low)
low$conc <- as.numeric(low$conc)

###fixing units both rate and concentration are in mg g-1
low$resp<-low$rate*(low$water_mass+10)*0.01/low$sed_mass
low$npoc<-low$conc*(low$water_mass+10)*0.01/low$sed_mass
low$respC<-low$resp/32*12 ##convert mgDO g-1 to mgC g-1

low<-select(low, "site","respC","npoc","biomass","clay","silt","fine","med","coarse","ssa_tot")


#Merge data by site number--modeling results and measured concentration and rates
colnames(low.data)[1]<-"site"

low <- low %>% mutate(site = sprintf("%04d", as.numeric(site)))
low.data <- low.data %>% mutate(site = sprintf("%04d", as.numeric(site)))

low_all<-merge (low.data, low,by='site') 
write.csv(low_all,'low_all.csv', row.names = FALSE)
```


###Extract FTICR-MS features
```{r FTICRprep}

library(dplyr)
library(tidyr)


up_all<- read.csv("up_all.csv",colClasses=c("site"="character"))
mid_all<- read.csv("mid_all.csv",colClasses=c("site"="character"))
low_all<- read.csv("low_all.csv",colClasses=c("site"="character"))

# Combine
all_data <- bind_rows(up_all, mid_all, low_all)


#-------------------------------
# Helper functions
#-------------------------------

quant_fun <- function(x, probs) {
  as.numeric(quantile(x, probs = probs, na.rm = TRUE))
}

frac_fun <- function(x) {
  mean(x, na.rm = TRUE)
}

#-------------------------------
# Main feature generation
# all_data: long FTICR table
#-------------------------------

fticr_features <- all_data %>%
  group_by(site, Position) %>%

  summarise(
    n_peaks = n(),                                 # richness
    
    #-----------------------
    # Diversity (Shannon)
    #-----------------------
    shannon = {
      p <- rep(1/n(), n())                         # equal weights, no intensity data
      -sum(p * log(p))
    },
   

    #-----------------------
    # Distribution statistics
    #-----------------------
    NOSC_med   = median(NOSC, na.rm = TRUE),
    NOSC_iqr   = IQR(NOSC, na.rm = TRUE),
    NOSC_mean  = mean(NOSC, na.rm = TRUE),
    NOSC_p10   = quant_fun(NOSC, 0.10),
    NOSC_p90   = quant_fun(NOSC, 0.90),
    NOSC_range90 = NOSC_p90 - NOSC_p10,

    DBE_med    = median(DBE, na.rm = TRUE),
    DBE_mean   = mean(DBE, na.rm = TRUE),
    DBE_iqr    = IQR(DBE, na.rm = TRUE),

    AI_med     = median(AI_Mod, na.rm = TRUE),
    AI_iqr     = IQR(AI_Mod, na.rm = TRUE),

    delG_med   = median(delGcat, na.rm = TRUE),
    delG_iqr   = IQR(delGcat, na.rm = TRUE),

    lambda_med = median(lambda, na.rm = TRUE),
    lambda_iqr = IQR(lambda, na.rm = TRUE),

    Cnum_med   = median(C_num, na.rm = TRUE),
    Cnum_iqr   = IQR(C_num, na.rm = TRUE),

    #-----------------------
    # Energetic metrics
    #-----------------------
    frac_NOSC_pos = mean(NOSC > 0, na.rm=TRUE),
    frac_NOSC_low = mean(NOSC < -1, na.rm=TRUE),

    #-----------------------
    # Aromaticity / DBE structure
    #-----------------------
    frac_AI_high = mean(AI_Mod > 0.5, na.rm=TRUE),
    DBE_C_ratio_mean = mean(DBE / C_num, na.rm = TRUE),

    #-----------------------
    # Chemical class composition
    #-----------------------

    frac_ConHC      = frac_fun(Class == "ConHC"),
    frac_Lipid      = frac_fun(Class == "Lipid"),
    frac_AminoSugar = frac_fun(Class == "AminoSugar"),
    frac_Protein    = frac_fun(Class == "Protein"),
    frac_Tannin     = frac_fun(Class == "Tannin"),
    frac_UnsatHC    = frac_fun(Class == "UnsatHC"),
    frac_Lignin     = frac_fun(Class == "Lignin"),
    frac_Carb       = frac_fun(Class == "Carb"),
    frac_Other      = frac_fun(Class == "Other"),

    # Example informative ratios
    ratio_Protein_Lignin = frac_Protein / frac_Lignin,
    ratio_Lipid_Carb     = frac_Lipid / frac_Carb,
    ratio_UnsatHC_ConHC  = frac_UnsatHC / frac_ConHC,
    #-----------------------
    # Merge physical traits (constant per sample)
    #-----------------------
    npoc = first(npoc),
    biomass = first(biomass),
    respC=first(respC),
    ssa_tot = first(ssa_tot),
    clay = first(clay),
    silt = first(silt),
    fine = first(fine),
    med = first(med),
    coarse = first(coarse),

    .groups = "drop"
  )

write.csv(fticr_features, "fticr_features.csv", row.names = FALSE)
```

